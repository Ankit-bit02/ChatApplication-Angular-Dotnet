<div class="flex flex-col h-full p-4" #chatBox>
  <div class="flex-1 space-y-4 overflow-y-auto scroll-smooth">

    <!-- Load More Button -->
    @if(chatService.chatMessages().length > 5) {
    <div class="flex justify-center py-2 sticky top-0 z-10">
      <button (click)="loadMoreMessage()"
        class="inline-flex items-center px-4 py-2 text-xs font-medium text-gray-600 bg-white border border-gray-300 rounded-full shadow-sm hover:bg-gray-50 hover:text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all">
        @if(chatService.isLoading()) {
        <mat-spinner diameter="16" strokeWidth="2" class="mr-2"></mat-spinner>
        Loading more messages...
        } @else {
        <mat-icon class="w-4 h-4 mr-2 text-gray-400">expand_more</mat-icon>
        Load earlier messages
        }
      </button>
    </div>
    }

    <!-- Chat Messages -->
    @for(message of chatService.chatMessages(); track message.id) {

    @if(message.senderId !== authService.currentLoggedUser?.id) {
    <!-- Received Message -->
    <div class="flex items-start space-x-3 max-w-4xl">
      <div class="flex-shrink-0">
        <img [src]="chatService.currentOpenedChat()?.profileImage" [alt]="chatService.currentOpenedChat()?.fullName"
          class="w-8 h-8 rounded-full object-cover ring-2 ring-white shadow-sm" />
      </div>
      <div class="flex-1">
        <div class="bg-white rounded-2xl rounded-tl-md px-4 py-3 shadow-sm border border-gray-100 max-w-sm">
          <p class="text-sm text-gray-800 leading-relaxed">
            {{message.content}}
          </p>
        </div>
        <p class="text-xs text-gray-400 mt-1 ml-2">
          {{message.createdDate | date:'short'}}
        </p>
      </div>
    </div>
    } @else {
    <!-- Sent Message -->
    <div class="flex items-start justify-end space-x-3 max-w-4xl ml-auto">
      <div class="flex-1 flex flex-col items-end">
        <div class="bg-blue-600 rounded-2xl rounded-tr-md px-4 py-3 shadow-sm max-w-sm">
          <p class="text-sm text-white leading-relaxed">
            {{message.content}}
          </p>
        </div>
        <p class="text-xs text-gray-400 mt-1 mr-2">
          {{message.createdDate | date:'short'}}
        </p>
      </div>
      <div class="flex-shrink-0">
        <img [src]="authService.currentLoggedUser?.profileImage" [alt]="authService.currentLoggedUser?.fullName"
          class="w-8 h-8 rounded-full object-cover ring-2 ring-white shadow-sm" />
      </div>
    </div>
    }
    } @empty {
    <!-- Empty State -->
    <div class="flex flex-col items-center justify-center h-full text-center py-12">
      @if(chatService.isLoading()) {
      <mat-spinner diameter="40" strokeWidth="3" class="mb-4"></mat-spinner>
      <p class="text-sm text-gray-500">Loading messages...</p>
      } @else {
      <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
        <mat-icon class="text-3xl text-gray-400">chat_bubble_outline</mat-icon>
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No messages yet</h3>
      <p class="text-sm text-gray-500 max-w-xs">
        Start the conversation by sending a message to {{chatService.currentOpenedChat()?.fullName}}.
      </p>
      }
    </div>
    }
  </div>
</div>